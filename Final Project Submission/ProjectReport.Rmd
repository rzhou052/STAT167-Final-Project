---
title: "Thisisafunnygroupname's Project Report"
author: "Richard Zhou, Adam Rui, Jonathan Darius, Ojasvi Godha, Ryan Huang, Isaac Kang"
output: 
  pdf_document:
    toc: true
---

\newpage

```{r, include = FALSE}
library("tidyverse")
library("nycflights13")
library("nycflights23")
library("dplyr")
library("lmtest")
library("sandwich")
library("mgcv")
library("ggrepel")
library("car")
library("patchwork")
library("gridExtra")
library("broom")
library("nortest")
```

```{r, include = FALSE}
# data cleaning
flights_combined <- bind_rows(nycflights13::flights %>% mutate(year = 2013), nycflights23::flights %>% mutate(year = 2023))

flights_clean <- flights_combined %>%
  filter(!is.na(dep_delay), !is.na(arr_delay)) %>%
  left_join(nycflights13::airlines, by = "carrier") %>%
  left_join(nycflights13::airports, by = c("dest" = "faa"))

destination_stats <- flights_clean |>
  filter(!is.na(name.y)) |>
  group_by(dest, name.y) |>
  summarise(
    total_flights = n(),
    avg_delay = mean(dep_delay + arr_delay),
    .groups = "drop"
  ) |>
  mutate(
    busyness = total_flights / sum(total_flights),
    busyness_rank = dense_rank(busyness)
  ) %>%
  arrange(busyness_rank)
```

# Introduction

Flight delays are a constant challenge in the air travel industry, impacting efficiency and passenger satisfaction. This project aims to investigate the underlying causes of flight delays in New York City and how these patterns have evolved over time. By analyzing both recent and historical flight data, we seek to identify the major contributors to delays and provide actionable insights for improving airline performance and the overall passenger experience.

# Project Description

This analysis will utilize the `nycflights13` and `nycflights23` datasets, which contain records of flights departing from NYC airports. The project will involve exploratory data analysis (EDA), statistical testing, and comparative analysis, using tools such as `dplyr`, `ggplot2`, and many more to assess the significance of delay-related factors. Through this project, we intend to discover trends and patterns in flight delays, to provide a deeper insight into the aspects we can improve in air travel.

Through this data analysis, we aim to answer the 5 following questions:

1.  Have flight delays improved over time overall? 

    -   What about with individual airlines?\

2.  Do busy destinations tend to have more or less delays?\

3.  Is the weather correlated with flight delays?

    -   How has this changed over time?\

4.  Is the time of the year correlated between flight delays (holidays or rainy season)?\

5.  Which airlines have the least delays?

    -   How has this changed over time?

# Data Description/Preparation

```{r, include = FALSE}
# setting seed
set.seed(167)

# data cleaning
flights_combined <- bind_rows(nycflights13::flights %>% mutate(year = 2013), nycflights23::flights %>% mutate(year = 2023))

flights_clean <- flights_combined %>%
  filter(!is.na(dep_delay), !is.na(arr_delay)) %>%
  left_join(nycflights13::airlines, by = "carrier") %>%
  left_join(nycflights13::airports, by = c("dest" = "faa"))
```

This project utilizes data from the `nycflights13` and `nycflights23` packages, which provide detailed records of flights departing from New York City in 2013 and 2023, respectively. The two flight datasets were combined into a single dataframe, with a new `year` variable added to distinguish between the two time periods. The resulting dataset, `flights_combined`, is also filtered to remove flights with missing departure or arrival delay values, and is further joined with the `airlines` and the `airports` datasets using appropriate keys. Our key attributes for this project include `dep_delay`, `arr_delay`, `carrier`, `dest`, and `year`, which are all key in exploring trends and changes in flight performance over the ten year period. We also used the `weather` dataset from both packages in order to find key relationships between delay patterns and weather.

\newpage

# Research Questions

## Have flight delays improved over time overall? What about with individual airlines?

```{r, include = FALSE}
# cleaning dataset for log transforms
flights_clean_log <- flights_combined %>%
  filter(!is.na(dep_delay), !is.na(arr_delay), dep_delay >= 0, arr_delay >= 0) %>%
  left_join(nycflights13::airlines, by = "carrier") %>%
  left_join(nycflights13::airports, by = c("dest" = "faa"))
```

### Part 1: Have flight delays improved or gotten worse between 2013 and 2023?

```{r, include = FALSE}
delay_by_carrier <- flights_clean_log %>%
  # specifies to calculate the average for each airline as well
  group_by(name.x, year) %>%
  summarise(avg_dep_delay = mean(dep_delay), .groups = 'drop')

dep_delay_model <- lm(data=flights_clean_log, dep_delay~factor(year))
```

First we test for normality.

```{r}
dep_delay_resids <- sample(residuals(dep_delay_model), size = 30000)

# Now plot the Q-Q plot with the sample for easier loading
qqnorm(dep_delay_resids)
qqline(dep_delay_resids, col = "red")
```

We don't seem to meet this assumption so let's do a shifted log transformation to help. This type of log transformation ensures all values are positive before the logging takes place and makes sure to include all values possible. After, we are going to check the normality assumption again.

```{r, include = FALSE}
min_dep_delay <- min(flights_clean$dep_delay, na.rm = TRUE)
flights_clean_log$log_dep_delay <- log(flights_clean_log$dep_delay - min_dep_delay + 1)
dep_delay_model_log <- lm(log_dep_delay ~ factor(year), data = flights_clean_log)

dep_delay_log_resids <- sample(residuals(dep_delay_model_log), size = 30000)
```

```{r}
# Now plot the Q-Q plot with the sample for easier loading
qqnorm(dep_delay_log_resids)
qqline(dep_delay_log_resids, col = "red")
```

And since the points are fairly close to the red line, we can say that the data is not from a perfect normal distribution, so despite this we will continue as it is fairly close.

```{r}
leveneTest(log_dep_delay ~ factor(year), data = flights_clean_log)
```

We can also check for homoscedasticity using the Levene's Test which is not met. The small p-value here shows signs of heteroscedasticity which means we cannot use regular 'summary()' to get results of the model. Let's look into the model itself using robust standard errors which assumes unequal error variances.

```{r}
coeftest(dep_delay_model_log, vcov = vcovHC)
```

This model helps us see the overall difference in departure delays between 2013 and 2023. The model shows a statistically significant increase in departure delays from 2013 to 2023, indicated by a positive coefficient with a very small p-value. In this context, we can conclude that that flight departure delays have gotten worse over time.

Let's do the whole process again, with arrival delays.

```{r, include = FALSE}
arr_delay_model <- lm(data=flights_clean_log, arr_delay~factor(year))

arr_delay_resids <- sample(residuals(arr_delay_model), size = 30000)
```

```{r}
# Now plot the Q-Q plot with the sample for easier loading
qqnorm(arr_delay_resids)
qqline(arr_delay_resids, col = "red")
```

We seem to have the same issue as the departure delays, so let's do another shifted log transformation and test again.

```{r, include = FALSE}
min_arr_delay <- min(flights_clean$arr_delay, na.rm = TRUE)
flights_clean_log$log_arr_delay <- log(flights_clean_log$arr_delay - min_arr_delay + 1)
arr_delay_model_log <- lm(log_arr_delay ~ factor(year), data = flights_clean_log)

arr_delay_log_resids <- sample(residuals(arr_delay_model_log), size = 30000)
```

```{r}
# Now plot the Q-Q plot with the sample for easier loading
qqnorm(arr_delay_log_resids)
qqline(arr_delay_log_resids, col = "red")
```

Again, the points are fairly close to the red line, so we can say that the data is not from a perfect normal distribution, it is close enough to continue.

```{r}
leveneTest(log_arr_delay ~ factor(year), data = flights_clean_log)
```

We can, again, check for homoscedasticity using the Levene's Test which is, again, not met. The small p-value here shows signs of heteroscedasticity which means we cannot use regular 'summary()' to get results of the model. Let's look into the model itself using robust standard errors which assumes unequal error variances.

```{r}
coeftest(arr_delay_model_log, vcov = vcovHC)
```

When we compare the arrival delays, we have a statistically significant increase as well, with a positive coefficient and small p-value, indicating that arrival delays have also gotten worse between 2013 and 2023, however slightly.

Let's take a quick look at the performance of both these arrival and delay models.

```{r, collapse=TRUE}
print(paste('Arrival Adj R^2: ', summary(arr_delay_model_log)$adj.r.squared))

print(paste("Departure Adj R^2: ", summary(dep_delay_model_log)$adj.r.squared))
```

The Adjusted R\^2 value helps us measure the quality of the model. These are really small values which means these models are not great. But in this case the small values are fine as the dataset is large, and the focus of this question was to identify average differences in delays over time, so the models still provided meaningful insights for this question.

For some additional comparison, we can try to see how much more or less departure delays have changed versus arrival delays from 2013 to 2023.

```{r}
both_delay_flights <- flights_clean_log %>%
  select(year, log_dep_delay, log_arr_delay) %>%
  pivot_longer(cols = c(log_dep_delay, log_arr_delay), 
               names_to = "delay_type", 
               values_to = "delay_value")

both_delay_model <- lm(data=both_delay_flights, delay_value~factor(year)*delay_type)
```

Let's first check for the normality assumption.

```{r, include = FALSE}
both_delay_resids <- sample(residuals(both_delay_model), size = 30000)
```

```{r}
# Now plot the Q-Q plot with the sample for easier loading
qqnorm(both_delay_resids)
qqline(both_delay_resids, col = "red")
```

Similar to plots before, we can say we have enough to continue despite not perfectly meeting the normality assumption. Now let's check for homoscedasticity with the Levene's Test.

```{r}
leveneTest(delay_value ~ factor(year)*delay_type,  data = both_delay_flights)
```

We can check for homoscedasticity using the Levene's Test which is, again, not met. The small p-value here shows signs of heteroscedasticity which means we cannot use regular 'summary()' to get results of the model. Let's look into the model itself using robust standard errors which assumes unequal error variances.

```{r}
coeftest(both_delay_model, vcov = vcovHC)
```

The key term in the model is 'factor(year)2023:delay_typedep_delay', which represents the additional change in departure delays from 2013 to 2023 relative to arrival delays. From the two previous models, we know arrival delays increased over the years by about 10% and departure delays increased by about 28%. In this combined model, we can see that as the coefficient is positive and, based on the p-value, is statistically significant. With this, we can conclude that the departure delays not only increased over time, but did so to a significantly greater extent than arrival delays did.

### Part 2: Have individual airlines gotten better or worse with delays over time?

```{r}
delay_model_airline <- lm(data=flights_clean_log, log_dep_delay~factor(year) * name.x)
summary(delay_model_airline)
```

Based on the F-statistic, this model is significant. However, there are a few airlines that seem to be discontinued in 2023, so lets remove them and create a new model.

```{r, include = FALSE}
# getting airlines that only appear in both years 
active_airlines <- flights_clean_log %>%
  group_by(name.x, year) %>%
  summarise(n = n(), .groups = "drop") %>%
  count(name.x) %>%
  filter(n == 2) %>%
  pull(name.x)

flights_filtered <- flights_clean_log %>%
  filter(name.x %in% active_airlines)
```

```{r}
dep_delay_model_airline_filtered <- lm(data=flights_filtered, log_dep_delay~factor(year) * name.x)
```

Now with our new model, let's check for the normality assumption.

```{r, include = FALSE}
dep_delay_airline_resids <- sample(residuals(dep_delay_model_airline_filtered), size = 30000)
```

```{r}
# Now plot the Q-Q plot with the sample for easier loading
qqnorm(dep_delay_airline_resids)
qqline(dep_delay_airline_resids, col = "red")
```

Despite the skewness suggesting we don't perfectly meet the normality assumption, we will continue. Now let's check for homoscedasticity with the Levene's Test.

```{r}
leveneTest(log_dep_delay ~ factor(year) * name.x, data = flights_filtered)
```

Based on the small p-value, we can see signs of heteroscedasticity which means we cannot use regular 'summary()' to get results of the model. Let's look into the model itself using robust standard errors which assumes unequal error variances.

```{r}
dep_delay_robust_se <- vcovHC(dep_delay_model_airline_filtered, type = "HC1")
dep_delay_tidy_robust_model <- tidy(coeftest(dep_delay_model_airline_filtered, vcov. = dep_delay_robust_se))

# only getting interaction terms, what we need 
dep_interaction_terms <- dep_delay_tidy_robust_model[grep(":", dep_delay_tidy_robust_model$term),]
print(dep_interaction_terms)
```

Based on the p-values, only 3 of these 10 airlines are statistically significant. Yet despite that we can still gain an idea of a general trend by looking at the coefficients. 6 out of 10 of these coefficients are positive, which means the majority of the airlines have gotten worse in 2023 compared to 2013.

Let's do this again with arrival delays.

```{r, include = FALSE}
arr_delay_model_airline_filtered <- lm(data=flights_filtered, log_arr_delay~factor(year) * name.x)
```

Let's check for the normality assumption.

```{r, include = FALSE}
arr_delay_airline_resids <- sample(residuals(arr_delay_model_airline_filtered), size = 30000)
```

```{r}
# Now plot the Q-Q plot with the sample for easier loading
qqnorm(arr_delay_airline_resids)
qqline(arr_delay_airline_resids, col = "red")
```

Based on this plot, despite the slight skewness, we can say we meet the normality assumption in a manner similar to previous plots. Now let's check for homoscedasticity with the Levene's Test.

```{r}
leveneTest(log_arr_delay ~ factor(year) * name.x, data = flights_filtered)
```

Based on the small p-value, we can see signs of heteroscedasticity which means we cannot use regular 'summary()' to get results of the model. Let's look into the model itself using robust standard errors which assumes unequal error variances.

```{r}
arr_delay_robust_se <- vcovHC(arr_delay_model_airline_filtered, type = "HC1")
arr_delay_tidy_robust_model <- tidy(coeftest(arr_delay_model_airline_filtered, vcov. = arr_delay_robust_se))

# only getting interaction terms, what we need 
arr_interaction_terms <- arr_delay_tidy_robust_model[grep(":", arr_delay_tidy_robust_model$term),]
print(arr_interaction_terms)
```

Based on the p-values here, again only 3 of these 10 airlines are statistically significant. We can still gain an idea of a general trend by looking at the coefficients. 6 out of 10 of these coefficients are negative, opposite of the departure trends. This means the majority of the airlines have actually gotten better in 2023 compared to 2013.

There are a few important limitations to note in this analysis. First, the assumption of independence may be violated, as flights from the same airline or airport are likely to be correlated. However, given the large sample size and the goal of identifying average differences in delays over time, we proceeded with the models, which still offered meaningful insights. Another limitation involves the normality assumption—although we applied shifted log transformations, the residuals still showed some skewness. Given the size of the dataset, we considered the approximation acceptable. With these limitations in mind, the findings remain useful, but should be interpreted with some caution.

### Graphs

```{r, echo = FALSE, warning = FALSE}
both_delay_filtered <- flights_filtered %>%
  select(year, name.x, dep_delay, arr_delay) %>%
  pivot_longer(cols = c(dep_delay, arr_delay),
               names_to = "delay_type",
               values_to = "delay_value")
```

Here, we can easily how the average arrival and departure delays have changed between 2013 and 2023. It seems that both arrival and departure delays have gotten worse.

```{r, echo = FALSE}
both_delay_filtered %>%
  group_by(name.x, year, delay_type) %>%
  summarise(mean_delay = mean(delay_value, na.rm = TRUE)) %>%
  ggplot(aes(x = year, y = mean_delay, color = name.x, group = name.x)) +
  geom_line(linewidth = 1) +
  geom_point() +
  facet_wrap(~delay_type, scales = "free_y") +
  labs(title = "Trends in Delay by Airline (2013 vs 2023)",
       x = "Year", y = "Average Delay (min)") +
  theme_minimal() +
  theme(legend.position = "none") 
```

\newpage

## Do busy destinations tend to have more or less delays?

### Data Exploration and Visualization

```{r, echo = FALSE}
destination_stats <- flights_clean |>
  filter(!is.na(name.y)) |>
  group_by(dest, name.y) |>
  summarise(
    total_flights = n(),
    avg_delay = mean(dep_delay + arr_delay),
    .groups = "drop"
  ) |>
  mutate(
    busyness = total_flights / sum(total_flights),
    busyness_rank = dense_rank(busyness)
  ) %>%
  arrange(busyness_rank)

important_airports <- destination_stats |>
  arrange(desc(avg_delay)) |>
  slice(c(1:5, (n()-4):n())) |>
  bind_rows(
    destination_stats |>
      arrange(desc(busyness)) |> 
      slice(1:5)  # 5 busiest
  ) |>
  distinct(dest, .keep_all = TRUE)

# for the correlation and p value
cor_test <- cor.test(destination_stats$busyness, destination_stats$avg_delay)
correlation <- cor_test$estimate
p_value <- cor_test$p.value

ggplot(destination_stats, aes(x = busyness, y = avg_delay)) +
  geom_point(aes(size = total_flights, color = avg_delay), alpha = 0.5) +
  
  # linear fit line
  geom_smooth(method = "lm", color = "red", se = FALSE) +
  
  # floating text for impotant airports
  geom_text_repel(
    data = important_airports,
    aes(label = paste(dest, name.y)), 
    size = 3,
    box.padding = 0.5
  ) +
  
  # add colors to visualise delay better
  scale_color_gradient2(
    low = "green", mid = "blue", high = "red", 
    midpoint = median(destination_stats$avg_delay)
  ) +
  labs(
    x = "Proportion of Total Flights (Busyness)",
    y = "Average Delay (minutes)",
    title = "Flight Delays vs. Destination Busyness",
    subtitle = sprintf(
      "Correlation: %.2f (p = %.3f)", 
      correlation, 
      p_value
    ),
    size = "Total Flights",
    color = "Avg Delay"
  )

# visualising heteroscedascity (helps w the reasoning of delays stabilizing w busyness)
# don't really need this but though it might be nice to add
variance_plot_data <- destination_stats |>
  mutate(busyness_bin = cut(busyness, breaks = 10)) |>
  group_by(busyness_bin) |>
  summarise(variance_delay = var(avg_delay, na.rm = TRUE), n_airports = n(),mid_busyness = mean(as.numeric(sub("\\((.*),(.*)\\]", "\\1", busyness_bin)))) |>
  filter(n_airports >= 3)

ggplot(variance_plot_data, aes(x = mid_busyness, y = variance_delay)) +
  geom_point(aes(size = n_airports), color = "steelblue", alpha = 0.7) +
  geom_smooth(method = "loess", color = "red", se = FALSE) +
  labs(
    x = "Airport Busyness",
    y = "Variance of Average Delays",
    title = "Heteroscedasticity Check: Variance of Delays vs. Busyness",
    subtitle = "Each point represents a group of airports with similar busyness levels",
    size = "Number of Airports"
  )
```

The scatter plot shows the average delay against the busyness of each airport, where the colour is is also indicative of delay length, and the size of the point is also indicative of busyness. Using the simple linear fit demonstrates no statistical significance of correlation between the two variables, however assumption checking may reveal otherwise (it doesn't, but always check). It's also apparent that as busyness increases the average delay tends to stabilize (as demonstrated in the Heteroscedasticity graph) to around 20 minutes, potentially being correlated with the available infrastructure at each airport to minimize random issues that result in higher delays.

### Data Analysis/Modeling/Predictions

```{r}
model <- lm(avg_delay ~ busyness, data = destination_stats)
bptest(model)  # p > 0.05 = homoscedastic
```

The Breusch-Pagan test reveals that the data is not homoscedastic, with a p-value below 0.05 (0.0196), indicating that the variance isn't constant.

```{r}
shapiro.test(residuals(model))
```

The Shapiro-wilk test reveals that the data is not normal, with a p value \< 0.05 (6.72e-09).

```{r}
# accounting for heteroscedasticity (robust standard error)
coeftest(model, vcov = vcovHC(model, type = "HC1"))
```

Using robust standard errors to account for heteroscedasticity, reveals there is still no statistical significance between the correlation of delay and busyness (p-value of 0.5548, \> 0.05).

```{r}
# accounting for normality (np regression)
model_gam <- gam(avg_delay ~ s(busyness), data = destination_stats)
summary(model_gam)
```

The GAM produced an smooth term p = 0.662, which indicates that the smooth term is not significant, which is backed up by the R\^2 value of near zero (-0.00701), meaning almost none of the variance can be explained by busyness.

### Results and Insights

Testing revealed that the data was neither normal, nor homoscedastic. Analysis revealed that busyness has no statistically significant correlation with flight delays (p = 0.55, robust SEs), with the model explaining virtually no variance (adj. R² = -0.007). A possible explanation for these issues is that delays may have a volume dependent variability, where busier airports can have both extremely on time flights and extremely delayed flights, increasing variance, or the large volume of small airports, where delays may be sporadic and unpredictable. It's also likely that most flights are on time, or have a very short delay, resulting in an extreme right skew, violating non normality. Several limitations of only analyzing busyness and delay, arise, such as the under fitting of the GAM, with an R\^2 near zero, indicating that the other predictors are missing (although they weren't required for this analysis specifically). Furthermore, although we tried to address the assumption violations with robust standard errors, the underlying skew of the data will probably require other methods to account for. Another important factor that was no accounted for was congestion of flights, different from busyness, as due to airport / airspace design, a small volume of flights may overwhelm an airport, resulting in an airport instead of busyness based delay. Our null result is still significant, however, as it is conclusive that more flights is not equal to longer delays.

\newpage

## How does weather impact flight performance, and has it changed over time?

### Data Exploration and Visualization

```{r, echo = FALSE}
airport_traffic <- flights_clean %>%
  group_by(origin, year) %>%
  # counts the number of  outgoing flights per airport per year
  summarise(num_flights = n(), .groups = 'drop') 

ggplot(airport_traffic, aes(x = origin, y = num_flights, fill = factor(year))) +
  geom_col(position = "dodge") +
  labs(title = "Number of Flights per NYC Airport (2013 vs 2023)", x = "Airport", y = "Number of Flights", fill = "Year")
```

This bar chart compares the number of flights at NYC airports (EWR, JFK, and LGA) in 2013 and 2023. All three airports experienced an increase in flights, with LaGuardia (LGA) showing the most significant growth. This may reflect recent infrastructure improvements at LGA and a broader rise in domestic air travel. The visualization clearly highlights these trends by contrasting the flight volumes side by side. Notably, LGA’s dramatic rise may suggest a shift in airline operations or passenger preference toward more centrally located airports.

```{r, include = FALSE}
# Join each year separately
fl13 <- nycflights13::flights %>%
  left_join(nycflights13::weather, by = c("year", "month", "day", "hour", "origin")) %>%
  mutate(dataset = "2013")

fl23 <- nycflights23::flights %>%
  left_join(nycflights23::weather, by = c("year", "month", "day", "hour", "origin")) %>%
  mutate(dataset = "2023")

# Combine both years
combined_all <- bind_rows(fl13, fl23)

# Clean NaNs
(combined_clean <- combined_all %>%
  filter(
    !is.na(dep_delay),
    !is.na(precip),
    !is.na(temp),
    !is.na(wind_gust)
  ) %>%
  mutate(month = month(time_hour.y, label = TRUE)))
```

We want to combine data sets from both 2013 and 2023. If we combine these data sets, we can have a combined data frame that contains data from both years, which would allow us to visualize and compare conditions across both years.

```{r, echo = FALSE}
# Plotting Departure Delays with Rain and No Rain
combined_clean %>%
  mutate(rain = ifelse(precip > 0, "Rain", "No Rain")) %>%
  ggplot(aes(x = rain, y = dep_delay, fill = dataset)) +
  geom_violin(scale = "width", alpha = 0.7, trim = FALSE, position = position_dodge(0.9)) +
  stat_summary(fun = median, geom = "point", shape = 23, fill = "white",
               position = position_dodge(0.9)) +
  coord_cartesian(ylim = c(0, 120)) +
  labs(title = "Departure Delay with Rain vs No Rain",
       x = "Weather Condition",
       y = "Departure Delay (min)",
       fill = "Year")
```

This violin plot compares departure delays under rainy and non-rainy conditions for the years 2013 and 2023. Overall, delays were higher during rain in both years, especially in 2013, suggesting weather remained a key factor in flight delays. Notably, 2023 shows a reduction in departure delays under both conditions, which may indicate improved scheduling, infrastructure, or weather forecasting technology. The visualization effectively shows not just the average delay but the distribution, revealing that extreme delays became less frequent by 2023.

```{r, echo = FALSE}
# Plotting when precipitation is greater than 0 over the course of 12 months in a year
combined_clean %>%
  filter(precip > 0) %>%
  group_by(dataset, month) %>%
  summarise(avg_delay = mean(dep_delay, na.rm = TRUE), .groups = "drop") %>%
  ggplot(aes(x = month, y = avg_delay, group = dataset, color = dataset)) +
  geom_line() +
  geom_point(size = 2) +
  labs(title = "Monthly Delay During Rain (2013 vs 2023)", x = "Month", y = "Average Delay (min)")
```

This line plot compares average monthly departure delays during rain in 2013 and 2023. Overall, 2023 shows consistently lower delays, especially during peak months like October, suggesting improvements in weather-related operations. The sharp spike in delays during October 2013 highlights a possible extreme weather event or operational issue that year. The visualization helps reveal both seasonal patterns and long-term improvements in delay management.

```{r, echo = FALSE}
# Scatter plot with line trend of precipitation greater than 0
combined_clean %>%
  filter(precip > 0) %>%
  ggplot(aes(x = precip, y = dep_delay, color = dataset)) +
  geom_point() +
  geom_smooth(method = "loess", se = FALSE) +
  coord_cartesian(xlim = c(0, .6), ylim = c(0, 100)) +
  labs(title = "Precipitation vs Departure Delay", x = "Precipitation (inches)", y = "Departure Delay (min)")
```

This scatter plot shows the relationship between precipitation and departure delay for 2013 and 2023. In 2013, delays generally increased with higher precipitation, suggesting weather had a stronger negative impact on flight schedules. In contrast, the 2023 trend line flattens and even slightly declines after moderate precipitation, indicating that delays were less sensitive to rainfall. This shift may reflect improved weather related protocols, better drainage systems, or more accurate forecasting. The visualization highlights how technological or operational improvements have mitigated the effects of precipitation on delays over time.

```{r, include = FALSE}
airports <- tibble(
  origin = c("JFK", "LGA", "EWR"), # NYC Airports
  lat = c(40.6398, 40.7750, 40.6925), # Latitude coordinates
  lon = c(-73.7789, -73.8680, -74.1687) # Longitude coordinates
)

# Map function to create map of each airport and their mean departure delays in mins
plot_delay_map <- function(data, year_label) {
  data %>%
    filter(dataset == year_label, precip > 0) %>%
    group_by(origin) %>%
    summarise(avg_delay = mean(dep_delay, na.rm = TRUE), .groups = "drop") %>%
    left_join(airports, by = "origin") %>%
    ggplot() +
    borders("state", colour = "black") +
    geom_point(aes(x = lon, y = lat, size = avg_delay),
               shape = 21, fill = "red", alpha = 0.8) +
    geom_text(aes(x = lon, y = lat, label = origin), nudge_y = 0.05) +
    coord_quickmap(xlim = c(-74.5, -73.5), ylim = c(40.5, 41)) +
    scale_size_continuous(name = "Avg Delay (min)", range = c(3, 10)) +
    labs(title = paste("Average Delay During Rain -", year_label), subtitle = "NYC Airports",
         x = "Longitude", y = "Latitude")
}
```

```{r}
plot_delay_map(combined_clean, "2013") # function applied for 2013
plot_delay_map(combined_clean, "2023") # function applied for 2023
```

These two maps compare the average departure delay during rain at NYC airports in 2013 and 2023. In 2013, delays were generally higher, especially at EWR, which had the largest delay among the three airports. By 2023, all airports saw reduced average delays during rain, with the most noticeable improvement at EWR. The visual contrast in bubble sizes between the two years suggests significant operational or infrastructure improvements that helped reduce weather-related delays citywide. Additionally, the shift in delay distribution indicates that efforts to balance air traffic and manage congestion more efficiently may have contributed to more consistent performance across all airports.

### Data Analysis/Modeling/Predictions

```{r, include = FALSE}
# code for testing your hypotheses/models  
weather_conditions <- combined_clean %>%
  select(dep_delay, precip, temp, wind_gust)
```

```{r}
# Fit linear model
model <- lm(dep_delay ~ precip + temp + wind_gust, data = weather_conditions)
summary(model)
```

A linear regression model was fitted to explore how weather conditions affect departure delays, using precipitation, temperature, and wind gust as predictors. All three variables were found to be highly significant (p \< 2e-16), with precipitation having the strongest effect, where each additional inch of rain was associated with over 175 minutes of added delay. However, despite their significance, the model's adjusted R-squared is only 0.01228, suggesting that weather explains just a small portion of the variability in delays. This indicates that while weather impacts delays, many other operational or systemic factors are likely at play. Before we hold these results as law, we must check all basic assumptions on our linear model to ensure accurate results.

```{r}
# --- NORMALITY CHECKS ---
# QQ-Plot
qqnorm(residuals(model))
qqline(residuals(model), col = "red")

# Anderson-Darling Test (better for large samples)
ad.test(residuals(model))
```

The Q-Q plot and Anderson-Darling test results both provide strong evidence that the residuals from the regression model do not follow a normal distribution assumption. The Q-Q plot shows extreme deviation from the diagonal line, particularly in the upper tail, indicating a heavy right skew and the presence of high outliers. This is confirmed by the Anderson-Darling test, which yields a test statistic of A = 75417 with a p-value \< 2.2e-16, strongly rejecting the null hypothesis of normality. Normality is a key assumption for valid inference in linear regression, these results suggest that caution should be used when interpreting p-values or confidence intervals from our prior modeling.

```{r}
# --- INDEPENDENCE CHECK ---
# Durbin-Watson Test
dwtest(model)
```

The Durbin-Watson test shows significant positive autocorrelation in the residuals (DW = 1.5473, p \< 2.2e-16), indicating a violation of the independence assumption. This suggests that residuals are correlated over time, meaning the model may be missing important temporal patterns. To address this, time series modeling or including lagged predictors could improve the model’s performance.

```{r}
# --- HOMOSCEDASTICITY CHECK ---
# Residuals vs Fitted plot
plot(model$fitted.values, residuals(model),
     main = "Residuals vs Fitted", xlab = "Fitted values", ylab = "Residuals")
abline(h = 0, col = "red")

leveneTest(dep_delay ~ factor(precip > 0), data = weather_conditions)
```

The residuals vs. fitted plot shows a clear funnel shape, indicating heteroscedasticity which indicates non-constant variance in the residuals across levels of fitted values. This visual pattern is strongly supported by Levene’s Test for homogeneity of variance, which is highly significant (F = 1628.5, p \< 2.2e-16), rejecting the null hypothesis of equal variances. Together, these results suggest that the model violates the assumption of homoscedasticity, which can lead to inefficient estimates and unreliable standard errors.

```{r}
# --- MULTICOLLINEARITY CHECK ---
# VIF (Variance Inflation Factor)
vif(model)
```

The VIF values for precipitation (1.005), temperature (1.040), and wind gust (1.045) indicate very low multicollinearity among the predictors. Since all values are close to 1, there is little concern that the variables are linearly dependent. This suggests that each predictor contributes unique information to the regression model.

### Results and Insights

The results show that weather variables like precipitation, temperature, and wind gust are significantly correlated with departure delays, though they explain only a small fraction of the overall variance. Delays due to rain have decreased notably from 2013 to 2023, suggesting operational improvements over time. However, violations of key regression assumptions indicate that more advanced modeling may be needed for accurate prediction.

## Does time of year affect flight delays?

[Talk about possible insights you could make from your results. Discuss the limitations your study has, and the interpretations of it.]

### Data Exploration and Visualization

```{r, echo = FALSE}
flights_clean %>%
  # get month from time_hour
  mutate(month = month(time_hour, label = TRUE)) %>% 
  group_by(month, year) %>%
  # compute average departure delay for that month
  summarise(avg_dep_delay = mean(dep_delay), .groups = 'drop') %>% 
  # plotting departure delays by month
  ggplot(aes(x = month, y = avg_dep_delay, group = year, color = factor(year))) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 4) +
  labs(title = "Seasonal Pattern of Departure Delays", x = "Month", y = "Avg Departure Delay (mins)", color = "Year") +
  theme_bw()
```

This line chart shows how departure delays vary across months for both years. We observe clear seasonal patterns: delays tend to peak during the summer months (June, July, and sometimes August), likely due to increased travel demand during vacation season. In 2013, there is also a secondary peak in December, which may reflect holiday travel congestion or winter weather disruptions. On the other hand, delays in December 2023 appear lower—potentially due to post-pandemic shifts in travel patterns or operational adjustments by airlines. To test whether these apparent seasonal patterns are statistically significant, we next conducted ANOVA and diagnostic tests on the departure delay data.

### Data Analysis/Modeling/Predictions

```{r, include = FALSE}
# prepare data with numeric month
flights_seasonal <- flights_clean %>%
  mutate(month = month(time_hour, label = FALSE))
```

```{r}
# constant variance: levene's test for homogeneity of variance across months
leveneTest(dep_delay ~ as.factor(month), data = flights_seasonal)
```

The Levene’s test returned a p-value \< 0.05, indicating that the variances of departure delays are not equal across different months. This violates the homogeneity of variance assumption of ANOVA. However, since we are working with a very large sample size, ANOVA is generally robust to this violation, and the unequal variances are not likely to substantially bias the results.

```{r}
# normality, large sample size sensitive to tests, use graph
# sample 100 points for QQ plot
sample_dep_delay <- sample(flights_seasonal$dep_delay, 30000)

qqnorm(sample_dep_delay)
qqline(sample_dep_delay, col = "red")
```

The QQ plot visualizes how closely the distribution of departure delays follows a normal distribution. In this plot, we observe that the points deviate from the line, especially in the upper tail, indicating right-skewness in the delays. This suggests that the normality assumption is not perfectly met, though again, due to the large sample size, ANOVA remains fairly robust.

```{r}
# durbin-Watson test for autocorrelation/seasonal trend.
anova_model <- aov(dep_delay ~ as.factor(month)*as.factor(year), data = flights_seasonal)
dwtest(anova_model)
```

```{r}
# run one-way anova
anova_model1 <- aov(dep_delay ~ as.factor(month), data = flights_seasonal)
summary(anova_model1)

# run Durbin-Watson test on one-way anova model
dwtest(anova_model1)
```

The Durbin-Watson test assesses whether residuals from the model exhibit autocorrelation. A value close to 2 suggests no autocorrelation, while a value substantially below 2 indicates positive autocorrelation. In this case, the DW statistic was below 2 and the p-value was significant, suggesting positive autocorrelation — likely due to underlying seasonal patterns or trends in the data. This implies that time-series models might be more appropriate in future analyses.

The one-way ANOVA tests whether average departure delay differs by month. The p-value for the month factor was essentially zero (well below 0.05), so we reject the null hypothesis. This provides strong statistical evidence that average departure delays vary significantly across months — supporting the idea of a seasonal pattern in delays.

```{r}
# run two-way anova
summary(anova_model)
```

The two-way ANOVA includes both month and year as factors, and their interaction. All main effects and the interaction term were statistically significant (p \< 0.05). This indicates that not only do delays vary by month and year individually, but also that the seasonal patterns differ between years — meaning the month-to-month delay pattern in 2013 is not exactly the same as in 2023.

```{r}
# linear model for two-way anova to calculate adjusted r-squared
lm1 <- lm(dep_delay ~ as.factor(month)*as.factor(year), data = flights_seasonal)
summary(lm1)$adj.r.squared
```

The adjusted R-squared measures how well the model explains variability in departure delays, adjusted for the number of predictors. The value was moderate (typically around 0.1 - 0.2 in this kind of flight delay data), indicating that while month and year account for some of the variability in delays, many other factors (e.g. weather, airline, airport operations) remain unaccounted for. This is expected in a complex system like air travel.

### Results and Insights

While the ANOVA models revealed statistically significant effects of both month and year on average departure delays, there are important limitations to note. First, the Levene’s test showed unequal variances, and the QQ plot suggested right-skewed residuals — though large sample size mitigates these violations. Second, the Durbin-Watson test indicated positive autocorrelation, meaning a time-series approach could better model the temporal trends in delays. Third, the adjusted R-squared was relatively low, underscoring that many delay-related factors are not captured in this simple model (e.g. weather, airline staffing, operational issues). Nevertheless, clear seasonal patterns were observed: delays tend to peak in summer months and around holidays. Moreover, differences between 2013 and 2023 suggest evolving travel behaviors, possibly due to post-pandemic effects or changes in airline operations. A more sophisticated model (e.g. time series or mixed effects) could improve predictive performance. In real-world terms, this analysis highlights when travelers and airlines might anticipate more delays — offering insights for scheduling, staffing, and customer planning.

\newpage

## Which airlines have the least delays? How has this changed over time?

### Data Exploration and Visualization

```{r, include = FALSE}
reliable_airlines <- flights_clean %>%
  group_by(name.x, year) %>%
  summarise(avg_dep_delay = mean(dep_delay, na.rm = TRUE), .groups = "drop")

top5_2013 <- reliable_airlines %>%
  filter(year == 2013) %>%
  slice_min(avg_dep_delay, n = 5) %>%
  arrange(avg_dep_delay) %>%
  mutate(name.x = factor(name.x, levels = name.x))

top5_2023 <- reliable_airlines %>%
  filter(year == 2023) %>%
  slice_min(avg_dep_delay, n = 5) %>%
  arrange(avg_dep_delay) %>%
  mutate(name.x = forcats::fct_na_value_to_level(name.x, level = "Allegiant Air")) %>%
  mutate(name.x = factor(name.x, levels = name.x))
```

```{r, echo = FALSE}
p1 <- ggplot(top5_2013, aes(x = name.x, y = avg_dep_delay)) +
  geom_col(fill = "#f8766d", width = 0.6) +
  geom_text(aes(label = round(avg_dep_delay, 1)), vjust = -0.3, size = 3) +
  labs(title = "Top 5 Airlines - 2013", x = "Airline", y = "Avg Departure Delay (min)") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2 <- ggplot(top5_2023, aes(x = name.x, y = avg_dep_delay)) +
  geom_col(fill = "#00bfc4", width = 0.6) +
  geom_text(aes(label = round(avg_dep_delay, 1)), vjust = -0.3, size = 3) +
  labs(title = "Top 5 Airlines - 2023", x = "Airline", y = "Avg Departure Delay (min)") +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p1 + p2 + plot_layout(ncol = 2)
```

The bar plots highlight the top 5 airlines with the shortest average departure delays in 2013 and 2023. In 2013, carriers such as US Airways and Hawaiian Airlines demonstrated the best on-time performance, while in 2023, Allegiant Air and Endeavor Air emerged as the most punctual. A notable observation is the overall increase in average delays in 2023—the most efficient airline still averaged over 6 minutes of delay, compared to just 3.7 minutes in 2013. Alaska and American Airlines appear on both lists, indicating a level of operational consistency, though their relative rankings suggest a modest decline in performance over time. These shifts may reflect broader changes in the aviation industry, such as increased traffic volume, evolving airline strategies, or challenges tied to staffing, infrastructure, or post-pandemic recovery. The clear differences between years and among airlines prompted further statistical testing to determine whether these patterns are significant and to better understand the factors influencing airline reliability.

### Data Analysis/Modeling/Predictions

```{r, include = FALSE}
data_2013 <- flights_clean %>%
  filter(year == 2013, !is.na(dep_delay)) %>%
  select(name.x, dep_delay) %>%
  mutate(name.x = as.factor(name.x))

data_2023 <- flights_clean %>%
  filter(year == 2023, !is.na(dep_delay)) %>%
  select(name.x, dep_delay) %>%
  mutate(name.x = as.factor(name.x))
  
anova_2013 <- aov(dep_delay ~ name.x, data = data_2013)
anova_2023 <- aov(dep_delay ~ name.x, data = data_2023)

tukey_2013 <- TukeyHSD(anova_2013)
tukey_2023 <- TukeyHSD(anova_2023)

tukey_2013_df <- as.data.frame(tukey_2013$`name.x`) %>%
  mutate(pair = rownames(.)) %>%
  arrange(`p adj`) %>%
  head(10)

tukey_2023_df <- as.data.frame(tukey_2023$`name.x`) %>%
  mutate(pair = rownames(.)) %>%
  arrange(`p adj`) %>%
  head(10)
```

```{r}
# flights from 2013
shapiro.test(sample(resid(anova_2013), 5000))

# flights from 2023
shapiro.test(sample(resid(anova_2023), 5000))
```

```{r}
# flights from 2013
leveneTest(dep_delay ~ name.x, data = data_2013)

# flights from 2023
leveneTest(dep_delay ~ name.x, data = data_2023)
```

```{r}
# flights from 2013
dwtest(dep_delay ~ name.x, data = data_2013)

# flights from 2023
dwtest(dep_delay ~ name.x, data = data_2023)
```

To ensure the validity of our ANOVA results, we tested all three key assumptions: normality of residuals, homogeneity of variance, and independence of observations. First, the Durbin-Watson test produced values close to 2 with p-values above 0.05, confirming that the residuals were independent. Levene’s Test showed p-values greater than 0.05 for both 2013 and 2023, supporting the assumption of equal variances across airline groups. For normality, we sampled 5000 residuals from each model due to Shapiro-Wilk's sample size limit. Lastly, both years returned p-values below 0.05 in the Shapiro-Wilk test, indicating some deviation from normality. However, given the large sample size and the fact that Levene’s Test confirmed homogeneity of variances, ANOVA remains robust and the results are still considered valid for this analysis. Together, these results suggest that the assumptions of ANOVA were reasonably satisfied for both years.

```{r}
summary(anova_2013)
summary(anova_2023)

tukey_2013_df
tukey_2023_df
```

The ANOVA results showed significant differences in average departure delays across airlines in both 2013 and 2023. Tukey HSD tests further revealed specific airline pairs with meaningful differences, highlighting operational disparities. As a result, we reject the null hypothesis and conclude that airline performance varies meaningfully, with some airlines having significantly lower delays than others in both years.

### Results and Insights

The results show significant differences in average departure delays across airlines in both 2013 and 2023, with some carriers consistently outperforming others. Tukey HSD tests identified specific airline pairs with meaningful performance gaps, reinforcing that airline reliability varies. However, the study is limited to NYC departures and focuses only on departure delays, excluding other factors like cancellations or delay causes. Minor violations of normality were noted, so while these findings suggest real differences in airline performance, broader conclusions should be made with caution.

\newpage

# Conclusions

1.  **Have flight delays improved over time overall?**

    -   **What about with individual airlines?**

From 2013 to 2023, both departure and arrival delays generally worsened, with departure delays showing a more noticeable increase. When looking at individual airlines, SkyWest, American, and Delta showed no significant change in either type of delay, suggesting stable performance over time. Frontier and JetBlue experienced significant increases in departure delays, while United showed a smaller, non-significant increase. Southwest Airlines significantly improved arrival delays, with possible improvement in departures as well. Envoy Air saw no change in departure delays but did show significant improvement in arrivals. Notably, Endeavor Air was the only airline to significantly improve in both departure and arrival delays.

2.  **Do busy destinations tend to have more or less delays?**

Since busyness is not statistically significantly correlated with the average delay of an airport, it is unlikely to draw any concrete conclusions on whether busy destinations have more or less delay on average. From what we've analysed, however, due to the lower variance as busyness increases, it is reasonable to conclude that larger airports offer a more consistent delay experience.

3.  **Is the weather correlated with flight delays?**

    -   **How has this changed over time?**

Yes, weather is correlated with flight delays, as shown by the significant coefficients in the regression model, particularly precipitation, increases delays. Although the relationship is statistically significant, the model's low R-squared value (\~0.012) indicates that weather explains only a small portion of the variability in delays. Over time, the impact of weather—especially rain—on delays appears to have lessened, as seen in the 2023 visualizations where delays during rain are generally lower and less variable than in 2013. Improvements in infrastructure, forecasting, and airline operations likely contributed to this reduction. Despite these improvements, all model assumptions are violated (non-normal residuals, autocorrelation, and heteroscedasticity), suggesting that more complex or time-aware models may better capture remaining delay patterns, and we must proceed with caution when interperting the results from the model.

4.  **Is the time of the year correlated between flight delays (holidays or rainy season)?**

The analysis provides strong evidence that the time of year is associated with variations in flight delays. The one-way ANOVA indicated that average delays differ significantly across months, reflecting a clear seasonal pattern. The two-way ANOVA further demonstrated that this pattern varies between years, suggesting that external factors—such as fluctuations in weather conditions or shifts in holiday travel demand—contribute to month-to-month differences in delays. Notably, the peaks observed during summer months and certain holiday periods correspond to times of increased travel volume and heightened risk of weather-related disruptions. However, it is important to acknowledge that some key ANOVA assumptions, including homogeneity of variance and normality of residuals, were not fully satisfied. As such, while the observed trends are consistent and informative, the findings should be interpreted with appropriate caution.

5.  **Which airlines have the least delays?**

    -   How has this changed over time?

Average delays increased in 2023 across the top-performing airlines, suggesting worsening punctuality industry-wide. This may be due to factors like increased air traffic, staffing shortages, or post-pandemic recovery challenges. These findings can inform consumers when choosing airlines and encourage airlines to reassess scheduling and efficiency strategies. However, a key limitation of this analysis is that it only includes flights departing from New York City airports, which may not reflect nationwide trends. Additionally, the analysis focuses solely on departure delays and does not account for arrival performance, which could further affect overall airline reliability. Lastly, this analysis did come with a few violations of key assumptions, meaning that we must take this information with a bit of caution.

\newpage

# Authors' Contributions

| Author          | Contributions        |
|-----------------|----------------------|
| Richard Zhou    | Project organization |
| Adam Rui        | Question 4           |
| Jonathan Darius | Question 3           |
| Ojasvi Godha    | Question 1           |
| Ryan Huang      | Question 2           |
| Isaac Kang      | Question 5           |
